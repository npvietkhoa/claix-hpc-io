#!/usr/bin/zsh
#SBATCH --job-name=scorep-{{ binary.replace('.x', '.' ~ ntasks) }}
#SBATCH --beeond
#SBATCH --exclusive
#SBATCH --time=01:59:00
## Explicit paths should be used for output 
#SBATCH --output=/hpcwork/$USER/beeond-logs/{{ binary.replace('.x', '.' ~ ntasks) }}.out

#SBATCH --ntasks={{ ntasks }}
#SBATCH --nodes=1

# Make sure the output directory exists
[ ! -d $HPCWORK/scorep-results ] && mkdir -p $HPCWORK/scorep-results
[ ! -d $HPCWORK/beeond-logs ] && mkdir -p $HPCWORK/beeond-logs

# Copy the binary to the BeeOND filesystem
cp {{ binary_path }} $BEEOND

# Rename the binary to include the number of tasks
mv $BEEOND/{{ binary_name }} $BEEOND/{{ binary_name.replace('.x', '.' ~ ntasks) }}

{% if library_path %}
LD_PRELOAD={{ library_path }} $MPIEXEC $BEEOND/{{ binary.replace('.x', '.' ~ ntasks) }}
{% else %}
$MPIEXEC $BEEOND/{{ binary.replace('.x', '.' ~ ntasks) }}
{% endif %}